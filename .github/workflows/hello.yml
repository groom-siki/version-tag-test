name: hi

on:
  push:
    tags:
      - 'v*'
  workflow_run:
    workflows: [ "production-release" ]
    types:
      - completed
  workflow_dispatch:
    inputs:
      tag-rollback:
        description: 프로덕션 배치 롤백 배포일 경우 true로 설정
        required: true
        default: false
        type: choice
        options:
          - false
          - true

jobs:
  verify:
    name: Github Actions 배포 상태 체크
    runs-on: ubuntu-latest
    if: |
      ${{ (github.event.workflow_run.conclusion == 'success' && github.event_name == 'workflow_run') || (github.event_name != 'workflow_run' && startsWith(github.ref, 'v')) }}
    steps:
      - name: Github Actions 배포 성공
        run: exit 0

  production-tag-type:
    name: 프로덕션 태그 타입 설정
    needs: verify
    runs-on: ubuntu-latest
    if: ${{ (github.event.workflow_run.conclusion == 'success' && github.event_name == 'workflow_run') }}
    steps:
      - name: 프로덕션 태그 결정
        id: tag-type-production
        run: |
          echo "TAG_TYPE=PRODUCTION" >> $GITHUB_OUTPUT
          echo ${{ steps.tag-type-production.outputs.TAG_TYPE }}
    outputs:
      tag-type: ${{ steps.tag-type-production.outputs.TAG_TYPE }}

  rollback-tag-type:
    name: 롤백 태그 타입 설정
    needs: verify
    runs-on: ubuntu-latest
    if: $ {{ github.event_name != 'workflow_run' && ${{ inputs.tag-rollback }} == 'true' && startsWith(github.ref, 'v') }}
    steps:
      - name: 롤백 태그 결정
        id: tag-type-rollback
        run: |
          echo "TAG_TYPE=ROLLBACK" >> $GITHUB_OUTPUT
          echo ${{ steps.tag-type-rollback.outputs.TAG_TYPE }}
    outputs:
      tag-type: ${{ steps.tag-type-rollback.outputs.TAG_TYPE }}

  tag-release:
    name: 태그 설정 후 배포
    needs: [production-tag-type, rollback-tag-type]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Extract Tag (Production)
        if: ${{ needs.production-tag-type.outputs.tag-type }} == 'PRODUCTION'
        run: |
          echo "this is ${{ needs.production-tag-type.outputs.tag-type }}"
          git fetch --all --tags
          echo "VERSION: $(git tag --list --sort=-v:refname | head -1 | sed 's/v//g')"
          echo "VERSION=`echo $(git tag --list --sort=-v:refname | head -1 | sed 's/v//g')`" >> $GITHUB_ENV

      - name: Extract Tag (Rollback)
        if: ${{ needs.rollback-tag-type.outputs.tag-type }} == 'ROLLBACK' && startsWith(github.ref, 'v')
        run: |
          echo "this is ${{ needs.rollback-tag-type.outputs.tag-type }}"
          echo "VERSION: ${{ github.ref }}"
          echo "VERSION=${{ github.ref }}" >> $GITHUB_ENV

      - name: Checkout-new-tag
        uses: actions/checkout@v3
        with:
          ref: ${{ env.VERSION }}

      - name: hi
        run: |
          echo "hello world"
          echo ${{ env.VERSION }}
          echo ${{ github.event_name }}
          echo ${{ github.ref }}
          echo ${{ github.repository }}
          echo ${{ github.workspace }}
          echo ${{ startsWith(github.event.workflow_run.conclusion, 'success') && startsWith(github.event_name, 'workflow_run') }}
        if: startsWith(github.event.workflow_run.conclusion, 'success') || startsWith(github.event_name, 'workflow_run')